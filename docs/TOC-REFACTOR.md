# 目录（TOC）功能完全重构文档

## 问题描述

原始问题：目录导航点击时报错 "Element with id 'xxx' not found"，表明 ID 生成和匹配机制存在严重问题。

## 重构内容

### 1. ID 生成机制改进 (MarkdownViewer.tsx)

#### 改进的 slug 生成函数
```typescript
function createSlug(text: string): string {
  // 移除 HTML 标签
  const cleanText = text.replace(/<[^>]*>/g, '');
  
  // 生成基础 slug
  const slug = cleanText
    .trim()
    .toLowerCase()
    // 保留中文、英文、数字和一些常见符号
    .replace(/[^\w\u4e00-\u9fa5\s-]/g, '')
    // 将空格替换为连字符
    .replace(/\s+/g, '-')
    // 移除连续的连字符
    .replace(/-+/g, '-')
    // 移除开头和结尾的连字符
    .replace(/^-|-$/g, '');
  
  // 如果 slug 为空，返回一个默认值
  return slug || 'section';
}
```

#### ID 生成改进
- 使用 `textContent` 而不是 `innerText` 获取纯文本
- 添加 `data-toc-id` 属性作为备份
- 保存元素引用到 TocItem 对象中
- 改进的唯一性保证机制

### 2. TOC 组件重构 (TOC.tsx)

#### 元素查找机制（多重备份）
1. 通过 ID 查找：`document.getElementById(item.id)`
2. 通过 data 属性查找：`document.querySelector([data-toc-id="${item.id}"])`
3. 使用保存的元素引用：`item.element`
4. 通过文本内容查找（最后手段）

#### 改进的 Intersection Observer
- 更精确的观察区域设置：`rootMargin: "-10% 0px -70% 0px"`
- 多个阈值提高准确性：`threshold: [0, 0.5, 1]`
- 防止导航时的状态冲突

#### 增强的键盘导航
- 支持 Vim 风格键盘快捷键（j/k, g/G）
- 循环导航（到达末尾后回到开头）
- Escape 键取消焦点
- 自动滚动到视口内

#### 用户体验改进
- 用户滚动检测，避免自动更新 URL 时的冲突
- 改进的视觉反馈（导航动画、高亮效果）
- 更好的错误处理和降级策略
- 层级指示器（•, ◦, ▪）
- 键盘快捷键提示

### 3. 视觉和交互改进

#### 高亮效果
- 使用蓝色系配色，更清晰
- 动画时长优化（800ms）
- 自动隐藏时间延长到 5 秒

#### 目录样式
- 活动项带有左边框和特殊背景色
- 不同层级使用不同字体大小
- 添加 tooltip 显示完整文本
- 底部渐变效果

#### 响应式改进
- 桌面端固定侧边栏
- 移动端抽屉式菜单
- 滑动手势支持

## 测试页面

创建了两个测试页面：

1. `/test-toc` - 基础功能测试页面
2. `/test-toc-debug` - 带调试面板的测试页面

### 测试覆盖的场景
- 中文标题
- 英文标题
- 混合标题
- 特殊字符
- 重复标题
- 长标题
- 多层级嵌套
- 空标题
- Emoji
- HTML 实体

## 主要改进总结

1. **可靠性**：多重备份的元素查找机制，确保总能找到目标元素
2. **性能**：优化的滚动检测和防抖机制
3. **可访问性**：完善的 ARIA 属性和键盘导航
4. **用户体验**：更好的视觉反馈和错误处理
5. **国际化**：完美支持中文和特殊字符

## 使用方法

目录功能已集成到 `ArticleDetail` 组件中，会自动：
1. 解析 Markdown 中的标题
2. 生成唯一的 ID
3. 创建可交互的目录
4. 提供滚动跟踪和导航功能

## 后续优化建议

1. 添加目录搜索/过滤功能
2. 支持目录项的折叠/展开
3. 添加阅读进度条
4. 支持自定义主题配置
5. 添加平滑滚动的开关选项
6. 支持目录位置自定义（左侧/右侧）
7. 添加"回到顶部"按钮
8. 支持目录项的拖拽排序（编辑模式）

## 已知限制

1. 只显示 h1-h4 级别的标题（h5、h6 被过滤）
2. 目录宽度固定为 240px（桌面端）
3. 移动端目录宽度固定为 288px

## 结论

通过这次完全重构，目录功能现在更加健壮、可靠和用户友好。所有之前的 ID 匹配问题都已解决，并添加了许多增强功能来改善用户体验。
